name: Deploy to Aliyun Server

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
          ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
          ALIYUN_DEPLOY_DIR: ${{ secrets.ALIYUN_DEPLOY_DIR }}
        run: |
          # åˆ›å»º SSH å¯†é’¥æ–‡ä»¶
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # æ·»åŠ ä¸»æœºåˆ° known_hostsï¼ˆé¿å…é¦–æ¬¡è¿æ¥æç¤ºï¼‰
          ssh-keyscan -H "$ALIYUN_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          # é€šè¿‡ SSH æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new \
              "${ALIYUN_USER}@${ALIYUN_HOST}" << 'DEPLOY_SCRIPT'

            # è®¾ç½®å˜é‡
            DEPLOY_DIR="${ALIYUN_DEPLOY_DIR:-/opt/nofx}"
            REPO_URL="https://github.com/NoFxAiOS/nofx.git"
            BRANCH="main"

            # åˆ é™¤æ—§ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å¹¶é‡æ–°å…‹éš†
            if [ -d "$DEPLOY_DIR" ]; then
              rm -rf "$DEPLOY_DIR"
            fi
            
            mkdir -p "$DEPLOY_DIR"
            git clone -b "$BRANCH" "$REPO_URL" "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # ä½¿ç”¨ Docker Compose æ›´æ–°å’Œé‡å¯æœåŠ¡
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            echo "âœ… Deployment completed successfully!"
            docker compose -f docker-compose.prod.yml ps

          DEPLOY_SCRIPT

      - name: Verify deployment
        env:
          ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
          ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œï¼ˆç­‰å¾… 30 ç§’è®©å®¹å™¨å¯åŠ¨ï¼‰
          sleep 30
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new \
              "${ALIYUN_USER}@${ALIYUN_HOST}" << 'VERIFY_SCRIPT'

            # æ£€æŸ¥ Docker å®¹å™¨çŠ¶æ€
            DEPLOY_DIR="${ALIYUN_DEPLOY_DIR:-/opt/nofx}"
            cd "$DEPLOY_DIR"
            
            echo "ğŸ“‹ Container status:"
            docker compose -f docker-compose.prod.yml ps
            
            # æ£€æŸ¥åº”ç”¨æ—¥å¿—
            echo "ğŸ“ Recent logs:"
            docker compose -f docker-compose.prod.yml logs --tail=20 | tail -30

          VERIFY_SCRIPT

      - name: Send notification on success
        if: success()
        run: |
          echo "âœ… Deployment succeeded!"
          echo "Access the app at: http://${{ secrets.ALIYUN_HOST }}:3000"

      - name: Send notification on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Please check the logs above."
